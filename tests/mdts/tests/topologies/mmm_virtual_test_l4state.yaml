# Copyright 2014 Midokura SARL
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#
# Virtual Topology
#

virtual_topology:
  description: Simple configuration with one router with three ports. Two
               uplinks and one downlink. DNAT and conntrack are applied to
               certain connections initiated from the downlink. All other
               traffic gets dropped.

  tenant_name: MMM-TEST-000-001

  routers:
    - router:
        name: router-000-001
        ports:
          - port:
              id: 1
              type: exterior
              ipv4_addr: 192.168.0.254/24
              ipv6_addr: null
          - port:
              id: 2
              type: exterior
              ipv4_addr: 172.16.42.254/24
              ipv6_addr: null
          - port:
              id: 3
              type: exterior
              ipv4_addr: 172.16.84.254/24
              ipv6_addr: null

        routes:
          - route:
              id: 1
              type: Normal
              src_addr: 0.0.0.0/0
              dst_addr: 192.168.0.0/24
              weight: 100
              next_hop_port: 1
              next_hop_gw: 0.0.0.0
          - route:
              id: 2
              type: Normal
              src_addr: 0.0.0.0/0
              dst_addr: 172.16.42.0/24
              weight: 100
              next_hop_port: 2
              next_hop_gw: 0.0.0.0
          - route:
              id: 3
              type: Normal
              src_addr: 0.0.0.0/0
              dst_addr: 172.16.84.0/24
              weight: 100
              next_hop_port: 3
              next_hop_gw: 0.0.0.0


  port_groups:
    - port_group:
        id: 1
        name: pg-1
        stateful: true
        ports:
          - port: [router-000-001, 2]
          - port: [router-000-001, 3]

# Connection tracking rules
  chains:
    - chain:
        id: 1
        name: router_infilter
        rules:
          - rule:
              id: 1
              position: 1
              type: rev_dnat
              flow_action: accept
              in_ports:
                - device_name: router-000-001
                  port_id: 2
                - device_name: router-000-001
                  port_id: 3
          - rule:
              id: 2
              position: 2
              type: dnat
              flow_action: accept
              nw_src_address: 192.168.0.1
              nw_src_length: 32
              nw_dst_address: 21.42.84.168
              nw_dst_length: 32
              match_forward_flow: true
              in_ports:
                - device_name: router-000-001
                  port_id: 1
              nat_targets:
                - addressFrom: 172.16.42.1
                  addressTo: 172.16.42.1
                  portFrom: 80
                  portTo: 80
          - rule:
              id: 3
              position: 3
              type: drop
