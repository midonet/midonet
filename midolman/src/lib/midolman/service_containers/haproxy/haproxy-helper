#!/bin/bash -x

# Copyright 2016 Midokura SARL
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

makens() {
    ip netns add $NAME
    DP=${IFACE}.out
    NS=${IFACE}.in
    ip link add name $DP type veth peer name $NS
    ip link set $DP up
    ip link set $NS netns $NAME
    ip netns exec $NAME ip link set up dev $NS
    ip netns exec $NAME ip link set up dev lo
}

cleanns() {
    if [ -z ${NAME} ]; then
        echo "no name specified (-n)"
        exit 1
    fi
    ip netns del $NAME
    ip link del $NAME
}

ACTION=$1
shift

if [ -z ${ACTION} ]; then
    echo "no action specified. What do you want me to do?"
    exit 1
fi

case $ACTION in
    makens)
        NAME=$1
        IFACE=$2
        makens
        ;;
    cleanns)
        NAME=$1
        cleanns
        ;;
esac
